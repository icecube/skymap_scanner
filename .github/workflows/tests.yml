name: tests

on: [push]

env:
  # NOTE: only put env vars here that make sense only for CI-purposes (see tests/docker_scripts/set_env.sh)
  PY_COLORS: "1"
  SKYSCAN_GCD_DIR: /cvmfs/icecube.opensciencegrid.org/users/RealTime/GCD/PoleBaseGCDs/

jobs:

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker Image
        run: |
          . ./tests/docker_scripts/set_env.sh
          ./tests/docker_scripts/docker_build.sh $SKYSCAN_CONTAINER

  # gather-test-events:
  #   runs-on: ubuntu-latest
  #   env:
  #     REALTIME_EVENTS_DIR: tests/data/realtime_events/
  #   outputs:
  #     matrix: ${{ steps.set-matrix.outputs.matrix }}
  #   steps:
  #     - uses: actions/checkout@v3
  #     - id: set-matrix
  #       run: |
  #         echo ::set-output name=matrix::{\"eventfile\":[$(find $GITHUB_WORKSPACE/$REALTIME_EVENTS_DIR -type f)]}\"

  test-run-all:
    needs: gather-test-events
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 10
      fail-fast: false
      # matrix: ${{fromJSON(needs.gather-test-events.outputs.matrix)}}
      matrix:
        eventfile: [
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/2890414988286888508.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/hese_event_00.json,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/-6447967553792706853.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/hese_event_03.json,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/hese_event_02.json,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/181316502608923741.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/-4995948919969127373.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/event_HESE_2017-11-28.json,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/-50979521318877545.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/3367288815241920337.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/hese_event_01.json,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/-243122034428012599.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/-8508219839558639919.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/903038395198487317.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/1996560004361018775.pkl,
          /home/runner/work/skymap_scanner/skymap_scanner/tests/data/realtime_events/6121837127383098916.pkl,
        ]
    env:
      CLIENTS_PER_CPU: 1  # there isn't any improvement when >1
    steps:
      - uses: actions/checkout@v3
      - uses: cvmfs-contrib/github-action-cvmfs@v2
        with:
          cvmfs_backoff_init: 2
          cvmfs_max_retries: 3
          cvmfs_dns_retries: 3
      - name: Test CernVM-FS
        run: ls $SKYSCAN_GCD_DIR
      - name: Run Pulsar Server Docker Container (starts up during skymap scanner image build)
        run: |
          . ./tests/docker_scripts/set_env.sh
          ./tests/docker_scripts/pulsar_run.sh $PULSAR_CONTAINER
      - name: Build Skymap Scanner Docker Image
        run: |
          . ./tests/docker_scripts/set_env.sh
          ./tests/docker_scripts/docker_build.sh $SKYSCAN_CONTAINER
      - name: Configure Pulsar Server
        run: |
          . ./tests/docker_scripts/set_env.sh
          ./tests/docker_scripts/pulsar_config.sh $PULSAR_CONTAINER
      - name: Run
        run: |
          . ./tests/docker_scripts/set_env.sh
          ./tests/docker_scripts/launch_server.sh $SKYSCAN_CONTAINER ${{ matrix.eventfile }} &

          nclients=$(( $CLIENTS_PER_CPU * $(nproc) ))
          echo "Launching $nclients clients"
          for i in $( seq 1 $nclients ); do
            ./tests/docker_scripts/launch_client.sh $SKYSCAN_CONTAINER ${{ matrix.eventfile }} &
            echo -e "\t$i clients launched"
          done

          wait -n  # for server
          for i in $( seq 1 $nclients ); do
            wait -n  # for client
          done
      # - name: Test Output
      #   run: |
      #     # docker run --rm -v $PWD:/mnt -i icecube/icetray:combo-stable-prod dataio-shovel -l millipede /mnt/test_event_01.i3

  # test-run-server:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: cvmfs-contrib/github-action-cvmfs@v2
  #       with:
  #         cvmfs_backoff_init: 2
  #         cvmfs_max_retries: 3
  #         cvmfs_dns_retries: 3
  #     - name: Test CernVM-FS
  #       run: ls $SKYSCAN_GCD_DIR
  #     - name: Run Pulsar Server Docker Container (starts up during skymap scanner image build)
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/pulsar_run.sh $PULSAR_CONTAINER
  #     - name: Build Skymap Scanner Docker Image
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/docker_build.sh $SKYSCAN_CONTAINER
  #     - name: Configure Pulsar Server
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/pulsar_config.sh $PULSAR_CONTAINER
  #     - name: Run
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/launch_server.sh $SKYSCAN_CONTAINER
  #     # - name: Test Output
  #     #   run: |

  # test-run-client:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: cvmfs-contrib/github-action-cvmfs@v2
  #       with:
  #         cvmfs_backoff_init: 2
  #         cvmfs_max_retries: 3
  #         cvmfs_dns_retries: 3
  #     - name: Test CernVM-FS
  #       run: ls $SKYSCAN_GCD_DIR
  #     - name: Run Pulsar Server Docker Container (starts up during skymap scanner image build)
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/pulsar_run.sh $PULSAR_CONTAINER
  #     - name: Build Skymap Scanner Docker Image
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/docker_build.sh $SKYSCAN_CONTAINER
  #     - name: Configure Pulsar Server
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/pulsar_config.sh $PULSAR_CONTAINER
  #     - name: Run
  #       run: |
  #         . ./tests/docker_scripts/set_env.sh
  #         ./tests/docker_scripts/launch_client.sh $SKYSCAN_CONTAINER
  #     # - name: Test Output
  #     #   run: |


  test-run-client-scanner:
    runs-on: ubuntu-latest
    env:
      SKYSCAN_CLIENT_SCANNER_FILES_DIR: tests/data/scan_pixel_pkls
      SKYSCAN_CLIENT_SCANNER_IN_FILENAME: in.pkl
      SKYSCAN_CLIENT_SCANNER_OUT_FILENAME: out.pkl
    steps:
      - uses: actions/checkout@v3
      - uses: cvmfs-contrib/github-action-cvmfs@v2
        with:
          cvmfs_backoff_init: 2
          cvmfs_max_retries: 3
          cvmfs_dns_retries: 3
      - name: Test CernVM-FS
        run: ls $SKYSCAN_GCD_DIR
      - name: Build Skymap Scanner Docker Image
        run: |
          . ./tests/docker_scripts/set_env.sh
          ./tests/docker_scripts/docker_build.sh $SKYSCAN_CONTAINER
      - name: Run
        run: |
          . ./tests/docker_scripts/set_env.sh
          ./tests/docker_scripts/_launch_scan_pixel.sh $SKYSCAN_CONTAINER
      # - name: Test Output
      #   run: |
